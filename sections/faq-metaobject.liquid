{%- liquid
  assign array = metaobjects.faqs.values
  assign size = metaobjects.faqs.values_count
  assign global_product_id = 'gid://shopify/Product/' | append: product.id
  assign array_faq_items = '' | split | sort

  paginate array by size
    for faq_item in array
      assign faq_keys = faq_item.add_to_product_s | join
      if faq_keys contains global_product_id
        assign array_item = faq_item | sort
        assign array_faq_items = array_faq_items | concat: array_item
      endif
    endfor
  endpaginate
-%}

{%- if array_faq_items.size != 0 and array_faq_items != blank -%}
  <div class="section-spacing {% if section.settings.separate_section_with_border %}bordered-section{% endif %}">
    <div class="container container--width">
      <div class="section-stack">
        {%- render 'section-header',
          subheading: section.settings.subheading,
          heading: section.settings.title,
          content: section.settings.content
        -%}

        <div class="faq">
          {%- assign categories_blocks = array_faq_items | map: 'category' | map: 'value' | uniq -%}
          {%- if section.settings.show_categories and categories_blocks.size > 0 -%}
            <faq-toc class="faq__toc hidden md:grid">
              {%- for block in categories_blocks -%}
                <a
                  class="faq__toc-item {% if forloop.first %}is-active{% endif %}"
                  href="#block-{{ block.title | handleize }}"
                >
                  {{- block.title -}}
                </a>
              {%- endfor -%}
            </faq-toc>
          {%- endif -%}

          <div class="faq__content">
            {%- for category in categories_blocks -%}
              {%- for faq_item in array_faq_items -%}
                {%- liquid
                  assign current_category = category.title | downcase
                  assign category_item = faq_item.category.value.title | downcase
                  assign category_title = faq_item.category.value.title
                  assign category_title_handle = faq_item.category.value.title | handleize
                -%}
                {%- if current_category == category_item -%}
                  {% comment %} Start Category {% endcomment %}
                  <p id="block-{{ category_title_handle }}" class="faq__category h4">
                    {{- category_title -}}
                  </p>
                  {% comment %} End Category {% endcomment %}

                  {% comment %} Start Items {% endcomment %}
                  {%- assign array_faq_items = array_faq_items | uniq -%}
                  {%- for faq_item_sub in array_faq_items -%}
                    {%- liquid
                      assign question_sub = faq_item_sub.question
                      assign answer_sub = faq_item_sub.answer
                      assign current_category_sub = category.title | downcase
                      assign category_item_sub = faq_item_sub.category.value.title | downcase
                    -%}
                    {%- if current_category_sub == category_item_sub -%}
                      {%- if question_sub != blank and answer_sub != blank -%}
                        {%- capture content -%}
                          <div class="prose">
                            {{- answer_sub -}}
                          </div>
                        {%- endcapture -%}
                        {%- render 'accordion', title: question_sub, show_title_as_text: true, content: content -%}
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                  {% comment %} End Items {% endcomment %}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>
  </div>

  {%- comment -%}We also output the content with JSON microdata for SEO{%- endcomment -%}

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {%- for faq_item in array_faq_items -%}
          {
            "@type": "Question",
            "name": {{ faq_item.question.value | json }},
            "acceptedAnswer": {
              "@type": "Answer",
              "text": {{ faq_item.answer.value | json }}
            }
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      ]
    }
  </script>
{%- endif -%}

{% schema %}
{
  "name": "FAQ metaobject",
  "class": "shopify-section--faq",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "separate_section_with_border",
      "label": "t:global.section.separate_section_with_border",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_categories",
      "label": "t:sections.faq.show_categories"
    },
    {
      "type": "header",
      "content": "t:global.section.header_category"
    },
    {
      "type": "inline_richtext",
      "id": "subheading",
      "label": "t:global.text.subheading",
      "default": "Need help?"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "t:global.text.heading",
      "default": "Frequently Asked Questions"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:global.text.content"
    }
  ],
  "presets": [
    {
      "name": "FAQ metaobject"
    }
  ]
}
{% endschema %}
